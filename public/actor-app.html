<!DOCTYPE html>
<!-- DANGER! WARNING! THEATER! app for displaying PDF files to follow Stage Manager scrolling -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> <!-- Prevent user zoom -->
    <title>Actor App - PlayScroller</title>
    <!-- Tailwind CSS for mobile-first, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            /* Hide scrollbars for body if they appear, though main scroll is on pdf-viewer-wrapper */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        body::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        #pdf-viewer-wrapper {
            position: relative; /* For positioning text layer and highlights */
            width: 100%;
            height: 100%; /* Take full available space */
            overflow-y: hidden; /* Disable manual scrolling */
            scroll-behavior: smooth; /* Smooth scrolling for programmatic jumps */
            /* Hide scrollbars for pdf-viewer-wrapper too, as SM controls scroll */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        #pdf-viewer-wrapper::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }


        canvas {
            display: block;
            margin: 0 auto;
            /* Optional: Add a subtle shadow to separate pages visually */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 8px; /* Space between pages */
        }

        /* --- Hamburger Menu Styles --- */
        #menu-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 9999px; /* circle */
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: block; /* Ensure it's block so we can use `display: none` for hiding */
        }
        #menu-button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        #side-menu {
            position: fixed;
            top: 0;
            right: 0;
            width: 250px;
            height: 100%;
            background-color: #fff;
            box-shadow: -4px 0 10px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            z-index: 999;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        #side-menu.open {
            transform: translateX(0);
        }
        #side-menu ul {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
            flex-grow: 1; /* Push close button to bottom if menu items are few */
        }
        #side-menu li {
            margin-bottom: 0.75rem;
        }
        #side-menu button {
            width: 100%;
            padding: 0.75rem;
            background-color: #f3f4f6; /* Light gray */
            border-radius: 0.5rem;
            text-align: left;
            font-size: 1rem;
            color: #1f2937; /* Dark gray */
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #side-menu button:hover {
            background-color: #e5e7eb; /* Lighter gray */
        }

        /* --- Custom highlight styling --- */
        .highlight {
            position: absolute;
            background-color: rgba(255, 255, 0, 0.5); /* Semi-transparent yellow */
            pointer-events: none; /* Allow interaction with elements beneath */
            z-index: 10; /* Ensure it's above PDF, below UI */
        }

        /* --- Modal for Highlight Input --- */
        #highlight-modal {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js"></script> <!-- Worker also needed -->
</head>
<body class="p-0"> <!-- Remove default padding -->

    <!-- Main Content Area - PDF Viewer -->
    <div id="pdf-viewer-wrapper">
        <!-- PDF Canvases and highlight divs will be rendered here -->
        <p id="loading-message" class="text-center py-12 text-gray-500 text-lg">Connecting to session and loading PDF...</p>
    </div>

    <!-- Hamburger Menu Button -->
    <button id="menu-button">
        <!-- Hamburger Icon (SVG for crispness) -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>

    <!-- Side Menu Panel -->
    <div id="side-menu">
        <button class="self-end p-2 bg-transparent text-gray-500 hover:text-gray-800" onclick="window.toggleMenu()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <ul>
            <li><button id="highlight-menu-item" onclick="window.handleHighlightClick()">Highlight...</button></li>
            <li><button id="exit-menu-item" onclick="window.exitApp()">Exit</button></li>
        </ul>
    </div>


    <!-- Generic Modal for Highlight Input / Errors -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <!-- Highlight Input specific elements -->
            <input type="text" id="highlight-text-input" placeholder="Enter text to highlight"
                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500 hidden">
            <div id="modal-buttons" class="flex justify-end space-x-4 mt-6">
                <button id="modal-cancel-btn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 hidden">Cancel</button>
                <button id="modal-ok-btn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Global Firebase Variables ---
        const firebaseConfig = {
          apiKey: "AIzaSyBG9pzEdllxWnZu0zYQMXqEFzJWNAVv6Lw",
          authDomain: "playscroller.firebaseapp.com",
          projectId: "playscroller",
          storageBucket: "playscroller.appspot.com",
          messagingSenderId: "86147104940",
          appId: "1:86147104940:web:f1bd908e1206795f9d1f09"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        let rtdb, auth, userId;
        let pdfDoc = null;
        let pdfViewerWrapper; // Our main scrollable div
        let currentSessionId = null;
        let currentPdfUrl = null;
        let activeHighlightText = ""; // Stores the text currently being highlighted

        // Ensure PDF.js worker is set up
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';


        // --- UI Utility Functions ---
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const highlightTextInput = document.getElementById('highlight-text-input');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        window.showModal = (title, message, isError = true, showInput = false, onOk = null, onCancel = null) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalTitle.className = isError ? 'text-xl font-bold mb-4 text-red-600' : 'text-xl font-bold mb-4 text-green-600';

            if (showInput) {
                highlightTextInput.value = activeHighlightText; // Pre-fill with current highlight
                highlightTextInput.classList.remove('hidden');
                modalCancelBtn.classList.remove('hidden');
                modalOkBtn.textContent = 'Highlight'; // Change text for highlight action
            } else {
                highlightTextInput.classList.add('hidden');
                modalCancelBtn.classList.add('hidden');
                modalOkBtn.textContent = 'OK'; // Default OK text
            }

            modalOkBtn.onclick = () => {
                window.closeModal();
                if (onOk) onOk(highlightTextInput.value);
            };
            modalCancelBtn.onclick = () => {
                window.closeModal();
                if (onCancel) onCancel();
            };

            modal.classList.remove('hidden');
        };

        window.closeModal = () => {
            modal.classList.add('hidden');
            highlightTextInput.value = ''; // Clear input on close
            // Reset button click handlers to default or generic close
            modalOkBtn.onclick = window.closeModal;
            modalCancelBtn.onclick = window.closeModal;
        };

        // --- Menu Functions ---
        const menuButton = document.getElementById('menu-button');
        const sideMenu = document.getElementById('side-menu');

        window.toggleMenu = () => {
            sideMenu.classList.toggle('open');
            // Hide menu button when side menu is open, show when closed
            menuButton.style.display = sideMenu.classList.contains('open') ? 'none' : 'block';
        };

        window.handleHighlightClick = () => {
            window.toggleMenu(); // Close the side menu
            window.showModal('Highlight Text', 'Enter text to highlight across the script:', false, true,
                (text) => {
                    activeHighlightText = text.trim();
                    // If text is cleared, remove highlights; otherwise, re-render
                    if (activeHighlightText === "") {
                        document.querySelectorAll('.highlight').forEach(el => el.remove());
                    } else {
                        renderHighlights(); // Re-render all pages with new highlight
                    }
                },
                () => { /* Cancelled, do nothing */ }
            );
        };

        window.exitApp = () => {
            if (window.opener) {
                window.close(); // Try to close the current tab/window
            } else {
                // If it's the main window, simply show a message or redirect.
                // Cannot force close window not opened by script.
                window.showModal('Exit App', 'You can close this tab/window manually.', false);
                // For a more graceful "exit" from a PWA or standalone app, you might redirect:
                // window.location.href = 'https://playscroller.web.app/';
            }
        };

        // --- Core App Initialization ---
        async function initializeFirebase() {
            try {
                if (!firebaseConfig.apiKey || Object.keys(firebaseConfig).length === 0) {
                     window.showModal('Configuration Error', 'Firebase API Key is missing or Firebase configuration is empty. Cannot initialize.', true);
                     return;
                }

                rtdb = getDatabase(app);
                auth = getAuth(app);

                await signInAnonymously(auth);
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Actor User ID:", userId); // For debugging, not in UI

                // Extract session_id and pdf_url from QR code URL
                const urlParams = new URLSearchParams(window.location.search);
                const sessionIdFromUrl = urlParams.get('session_id');
                const pdfUrlFromUrl = urlParams.get('pdf_url');

                if (!sessionIdFromUrl || !pdfUrlFromUrl) {
                    window.showModal('Connection Error', 'Missing Session ID or PDF URL in QR code link. Please scan the Stage Manager\'s QR code.', true);
                    document.getElementById('loading-message').textContent = 'Error: Missing session details.';
                    return;
                }

                currentSessionId = sessionIdFromUrl;
                currentPdfUrl = pdfUrlFromUrl;
                console.log("Connected to Session:", currentSessionId, "PDF URL:", currentPdfUrl); // For debugging

                document.getElementById('loading-message').textContent = `Connected to session ${currentSessionId}. Loading PDF...`;

                // Load and render PDF first
                await loadAndRenderPDF(currentPdfUrl);

                // Start listening for scroll state changes
                listenForScrollState();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                window.showModal('Initialization Failed', `Could not initialize Firebase: ${error.message}`, true);
                document.getElementById('loading-message').textContent = 'Error: Firebase initialization failed.';
            }
        }

        // --- PDF Rendering Functions ---
        async function renderPage(pageNumber, pdfPage) {
            // Scale to fit width of the viewer wrapper (which is 100vw/vh)
            const scale = pdfViewerWrapper.clientWidth / pdfPage.getViewport({ scale: 1 }).width;
            const viewport = pdfPage.getViewport({ scale: scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.id = `pdf-page-${pageNumber}`;
            canvas.setAttribute('data-page', pageNumber);

            const pageDiv = document.createElement('div');
            pageDiv.id = `page-div-${pageNumber}`;
            pageDiv.style.position = 'relative'; // For positioning highlight divs
            pageDiv.style.width = `${viewport.width}px`;
            pageDiv.style.height = `${viewport.height}px`;
            pageDiv.classList.add('pdf-page-wrapper'); // Custom class for styling if needed

            pageDiv.appendChild(canvas);
            pdfViewerWrapper.appendChild(pageDiv);

            await pdfPage.render({ canvasContext: context, viewport: viewport }).promise;

            // Store text content for later highlighting (do not render text layer explicitly)
            const textContent = await pdfPage.getTextContent();
            pdfPage.textContentItems = textContent.items; // Attach for later use
            pdfPage.viewport = viewport; // Also store viewport for highlight positioning
        }

        async function loadAndRenderPDF(pdfUrl) {
            pdfViewerWrapper.innerHTML = '<p id="loading-message" class="text-center py-12 text-gray-500 text-lg">Loading PDF, please wait...</p>';
            try {
                const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
                pdfDoc = pdf;
                pdfViewerWrapper.innerHTML = ''; // Clear loading message

                // Render all pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    await renderPage(i, page);
                }

                // After rendering all pages, apply initial highlights
                renderHighlights();

                // Initial scroll to top
                pdfViewerWrapper.scrollTop = 0;

            } catch (error) {
                console.error("PDF Loading Error:", error);
                window.showModal('PDF Loading Error', `Could not load PDF from URL. Check the URL and CORS settings. ${error.message}`, true);
                pdfViewerWrapper.innerHTML = '<p id="loading-message" class="text-center py-12 text-gray-500 text-lg">PDF loading failed.</p>';
                pdfDoc = null; // Reset document
            }
        }


        // --- Highlighting Logic ---
        async function renderHighlights() {
            // Clear all existing highlights before re-rendering
            document.querySelectorAll('.highlight').forEach(el => el.remove());

            if (!pdfDoc || !activeHighlightText) {
                return; // No PDF or no text to highlight
            }

            const searchTextLower = activeHighlightText.toLowerCase();

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const pageDiv = document.getElementById(`page-div-${i}`);
                if (!pageDiv) continue;

                const pdfPage = await pdfDoc.getPage(i);
                const textContentItems = pdfPage.textContentItems;
                const viewport = pdfPage.viewport; // Use stored viewport for this page

                if (!textContentItems || !viewport) continue;

                let fullText = textContentItems.map(item => item.str).join('');
                let matchIndex = fullText.toLowerCase().indexOf(searchTextLower);

                while (matchIndex !== -1) {
                    let charOffsetInItems = 0;
                    let matchStartItem = -1;
                    let matchEndItem = -1;
                    let startOffsetInFirstItem = 0;
                    let endOffsetInLastItem = 0;

                    // Find which text items contain the match
                    for (let j = 0; j < textContentItems.length; j++) {
                        const item = textContentItems[j];
                        const itemStrLower = item.str.toLowerCase();

                        if (matchStartItem === -1 && charOffsetInItems + itemStrLower.length > matchIndex) {
                            matchStartItem = j;
                            startOffsetInFirstItem = matchIndex - charOffsetInItems;
                        }
                        if (matchStartItem !== -1 && charOffsetInItems + itemStrLower.length >= matchIndex + searchTextLower.length) {
                            matchEndItem = j;
                            endOffsetInLastItem = (matchIndex + searchTextLower.length) - charOffsetInItems;
                            break;
                        }
                        charOffsetInItems += itemStrLower.length;
                    }

                    if (matchStartItem !== -1 && matchEndItem !== -1) {
                        const firstItem = textContentItems[matchStartItem];
                        const lastItem = textContentItems[matchEndItem];

                        // Calculate bounding box for the entire match segment
                        // This is a simplified calculation, a precise highlight might require more complex geometry
                        // from PDF.js's text rendering properties (font, size, transform matrix).
                        // For a visible highlight, we'll draw a rectangle over the approximate area.

                        const [x1, y1] = pdfjsLib.Util.applyTransform([firstItem.transform[4], firstItem.transform[5]], viewport.transform);
                        const [x2, y2] = pdfjsLib.Util.applyTransform([lastItem.transform[4] + lastItem.width, lastItem.transform[5]], viewport.transform);

                        const highlightSpan = document.createElement('div');
                        highlightSpan.className = 'highlight';

                        // Position and size the highlight div
                        highlightSpan.style.left = `${x1}px`; // Use x-coordinate of first item
                        highlightSpan.style.top = `${y1}px`;   // Use y-coordinate of first item
                        highlightSpan.style.height = `${firstItem.height * viewport.scale}px`; // Assume same height for simplicity

                        // Calculate width based on the extent of the match
                        let totalMatchWidth = 0;
                        for (let j = matchStartItem; j <= matchEndItem; j++) {
                            const item = textContentItems[j];
                            const itemWidth = item.width * viewport.scale; // Width of the item
                            if (j === matchStartItem) {
                                // For the first item, only consider the part from startOffsetInFirstItem
                                totalMatchWidth += itemWidth * (1 - (startOffsetInFirstItem / item.str.length));
                            } else if (j === matchEndItem) {
                                // For the last item, only consider up to endOffsetInLastItem
                                totalMatchWidth += itemWidth * (endOffsetInLastItem / item.str.length);
                            } else {
                                // Full width for intermediate items
                                totalMatchWidth += itemWidth;
                            }
                        }
                        // This is still an approximation, more accurate would be parsing char widths
                        highlightSpan.style.width = `${Math.max(1, totalMatchWidth)}px`; // Ensure min width of 1px


                        pageDiv.appendChild(highlightSpan);
                    }
                    // Find next match, starting after the current one
                    matchIndex = fullText.toLowerCase().indexOf(searchTextLower, matchIndex + searchTextLower.length);
                }
            }
        }


        // --- Real-Time Synchronization (Actor Listener) ---
        function listenForScrollState() {
            if (!currentSessionId || !rtdb) {
                console.error("Cannot listen for scroll state: Session ID or RTDB not initialized.");
                window.showModal('Real-time Error', 'Cannot connect to session. Realtime Database not ready.', true);
                return;
            }

            const viewStateRef = ref(rtdb, `sessions/${currentSessionId}/viewState`);

            onValue(viewStateRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const targetPage = data.page;
                    const targetYPercent = data.y_percent;
                    scrollToPageAndPosition(targetPage, targetYPercent);
                }
            }, (error) => {
                console.error("Error listening to Realtime Database:", error);
                window.showModal('Real-time Error', `Failed to receive real-time updates: ${error.message}`, true);
            });
        }

        // --- Scrolling Logic for Actor App ---
        function scrollToPageAndPosition(pageNumber, yPercent) {
            if (!pdfDoc || !pdfViewerWrapper) return;

            const targetPageDiv = document.getElementById(`page-div-${pageNumber}`); // Target the page wrapper div

            if (targetPageDiv) {
                // Calculate target Y position relative to the start of the page
                const targetScrollY = targetPageDiv.offsetTop + (targetPageDiv.clientHeight * (yPercent / 100));

                pdfViewerWrapper.scrollTo({
                    top: targetScrollY,
                    behavior: 'smooth'
                });
            } else {
                console.warn(`Target page div for page ${pageNumber} not found.`);
            }
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            pdfViewerWrapper = document.getElementById('pdf-viewer-wrapper'); // Our main scrollable div
            initializeFirebase();

            // Attach event listener for menu button
            menuButton.addEventListener('click', window.toggleMenu);
            // Close menu if click outside (basic implementation)
            document.addEventListener('click', (event) => {
                if (sideMenu.classList.contains('open') &&
                    !sideMenu.contains(event.target) &&
                    !menuButton.contains(event.target)) {
                    window.toggleMenu();
                }
            });
            // Ensure modal close button works
            modalOkBtn.onclick = window.closeModal;
        });

    </script>
</body>
</html>
