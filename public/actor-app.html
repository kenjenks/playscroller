<!DOCTYPE html>
<!-- DANGER! WARNING! THEATER! app for displaying PDF files to follow Stage Manager scrolling -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> <!-- Prevent user zoom -->
    <title>Actor App - PlayScroller</title>
    <!-- Tailwind CSS for mobile-first, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            /* Hide scrollbars for body if they appear, though main scroll is on pdf-viewer-wrapper */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        body::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        #pdf-viewer-wrapper {
            position: relative; /* For positioning highlight divs */
            width: 100%;
            height: 100%; /* Take full available space */
            overflow-y: hidden; /* Disable manual scrolling */
            scroll-behavior: smooth; /* Smooth scrolling for programmatic jumps */
            /* Hide scrollbars for pdf-viewer-wrapper too, as SM controls scroll */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        #pdf-viewer-wrapper::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* Wrapper for each PDF page (canvas + highlight overlay) */
        .pdf-page-wrapper {
            position: relative; /* Crucial for absolute positioning of canvas and overlay */
            margin: 0 auto 8px auto; /* Centered, with bottom margin */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow for visual separation */
            display: block; /* Ensure it takes up full width for centering */
        }

        canvas {
            display: block;
            margin: 0; /* Managed by parent .pdf-page-wrapper */
            position: absolute; /* Positioned within .pdf-page-wrapper */
            top: 0;
            left: 0;
            z-index: 1; /* Ensure canvas is below overlay */
        }

        /* This is the new container for highlights */
        .highlight-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2; /* Crucial: ensures it's above the canvas */
            pointer-events: none; /* Allows interaction with elements beneath */
            overflow: hidden; /* Prevent highlights from spilling out */
        }

        /* --- Hamburger Menu Styles --- */
        #menu-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 9999px; /* circle */
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: block; /* Ensure it's block so we can use `display: none` for hiding */
        }
        #menu-button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        #side-menu {
            position: fixed;
            top: 0;
            right: 0;
            width: 250px;
            height: 100%;
            background-color: #fff;
            box-shadow: -4px 0 10px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            z-index: 999;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        #side-menu.open {
            transform: translateX(0);
        }
        #side-menu ul {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
            flex-grow: 1; /* Push close button to bottom if menu items are few */
        }
        #side-menu li {
            margin-bottom: 0.75rem;
        }
        #side-menu button {
            width: 100%;
            padding: 0.75rem;
            background-color: #f3f4f6; /* Light gray */
            border-radius: 0.5rem;
            text-align: left;
            font-size: 1rem;
            color: #1f2937; /* Dark gray */
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #side-menu button:hover {
            background-color: #e5e7eb; /* Lighter gray */
        }

        /* --- Custom highlight styling --- */
        .highlight {
            position: absolute;
            background-color: rgba(255, 255, 0, 0.4); /* Semi-transparent yellow */
            /* NO BORDER - removed any border styling */
            border: none !important;
            border-radius: 2px;
            pointer-events: none; /* Allow interaction with elements beneath */
            z-index: 10;
            mix-blend-mode: multiply; /* Better blending with text */
            /* Ensure no outline or box-shadow */
            outline: none !important;
            box-shadow: none !important;
        }

        /* --- Modal for Highlight Input --- */
        #highlight-modal {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* Debug panel styles */
        #debug-panel {
            font-family: monospace;
        }

        #debug-content {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }

        #debug-button {
            z-index: 1001; /* Above everything */
        }

        /* Loading indicator for highlight search */
        .highlight-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 10000;
            display: none;
        }
    </style>
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js"></script> <!-- Worker also needed -->
</head>
<body class="p-0"> <!-- Remove default padding -->

    <!-- Main Content Area - PDF Viewer -->
    <div id="pdf-viewer-wrapper">
        <!-- PDF Canvases and highlight divs will be rendered here -->
        <p id="loading-message" class="text-center py-12 text-gray-500 text-lg">Connecting to session and loading PDF...</p>
    </div>

    <!-- Hamburger Menu Button -->
    <button id="menu-button">
        <!-- Hamburger Icon (SVG for crispness) -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>

    <!-- Side Menu Panel -->
    <div id="side-menu">
        <button class="self-end p-2 bg-transparent text-gray-500 hover:text-gray-800" onclick="window.toggleMenu()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <ul>
            <li><button id="highlight-menu-item" onclick="window.handleHighlightClick()">Highlight Text...</button></li>
            <li><button onclick="window.highlightAudience()">Highlight "AUDIENCE"</button></li>
            <li><button id="exit-menu-item" onclick="window.exitApp()">Exit</button></li>
        </ul>
    </div>

    <!-- Generic Modal for Highlight Input / Errors -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <!-- Highlight Input specific elements -->
            <input type="text" id="highlight-text-input" placeholder="Enter text to highlight"
                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500 hidden">
            <div id="modal-buttons" class="flex justify-end space-x-4 mt-6">
                <button id="modal-cancel-btn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 hidden">Cancel</button>
                <button id="modal-ok-btn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Highlight</button>
            </div>
        </div>
    </div>

    <!-- Debug Panel for Tablet Testing -->
    <div id="debug-panel" class="fixed bottom-0 left-0 right-0 bg-black bg-opacity-80 text-white p-3 z-50 hidden">
        <div class="flex justify-between items-center">
            <h3 class="font-bold">Debug Info</h3>
            <button onclick="window.toggleDebugPanel()" class="bg-red-500 px-3 py-1 rounded">×</button>
        </div>
        <div id="debug-content" class="mt-2 text-sm overflow-auto max-h-32">
            <!-- Debug messages will appear here -->
        </div>
    </div>

    <!-- Quick Debug Button -->
    <button id="debug-button" onclick="window.toggleDebugPanel()"
            class="fixed bottom-4 right-4 bg-blue-500 text-white p-3 rounded-full shadow-lg z-50">
        Debug
    </button>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Global Firebase Variables ---
        const firebaseConfig = {
          apiKey: "AIzaSyBG9pzEdllxWnZu0zYQMXqEFzJWNAVv6Lw",
          authDomain: "playscroller.firebaseapp.com",
          projectId: "playscroller",
          storageBucket: "playscroller.appspot.com",
          messagingSenderId: "86147104940",
          appId: "1:86147104940:web:f1bd908e1206795f9d1f09"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        let rtdb, auth, userId;
        let pdfDoc = null;
        let pdfViewerWrapper; // Our main scrollable div
        let currentSessionId = null;
        let currentPdfUrl = null;
        let activeHighlightText = ""; // Stores the text currently being highlighted

        // Ensure PDF.js worker is set up
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        // --- Debug Functions for Tablet Testing ---
        let debugMessages = [];

        window.showDebugMessage = (message, type = 'info') => {
            const timestamp = new Date().toLocaleTimeString();
            const formattedMessage = `[${timestamp}] ${message}`;
            debugMessages.push({ message: formattedMessage, type });

            // Keep only last 10 messages
            if (debugMessages.length > 10) {
                debugMessages.shift();
            }

            // Update debug panel if visible
            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                debugContent.innerHTML = debugMessages
                    .map(msg => `<div class="${msg.type === 'error' ? 'text-red-300' : 'text-green-300'}">${msg.message}</div>`)
                    .join('');
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        };

        window.toggleDebugPanel = () => {
            const panel = document.getElementById('debug-panel');
            const button = document.getElementById('debug-button');

            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                button.textContent = 'Hide Debug';
                button.classList.remove('bg-blue-500');
                button.classList.add('bg-red-500');
            } else {
                panel.classList.add('hidden');
                button.textContent = 'Debug';
                button.classList.remove('bg-red-500');
                button.classList.add('bg-blue-500');
            }
        };

        // Function to highlight "AUDIENCE" specifically - NO MODAL
        window.highlightAudience = () => {
            window.toggleMenu(); // Close menu
            activeHighlightText = "AUDIENCE";
            window.showDebugMessage(`Highlighting "${activeHighlightText}"...`, 'info');
            // Clear existing highlights first
            document.querySelectorAll('.highlight').forEach(el => el.remove());
            // Highlight without showing modal
            renderHighlightsForText(activeHighlightText);
        };

        // --- UI Utility Functions ---
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const highlightTextInput = document.getElementById('highlight-text-input');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // FIXED: Store the current callback functions before they're cleared
        let currentOkCallback = null;
        let currentCancelCallback = null;

        window.showModal = (title, message, isError = true, showInput = false, onOk = null, onCancel = null) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalTitle.className = isError ? 'text-xl font-bold mb-4 text-red-600' : 'text-xl font-bold mb-4 text-green-600';

            if (showInput) {
                highlightTextInput.value = activeHighlightText; // Pre-fill with current highlight
                highlightTextInput.classList.remove('hidden');
                modalCancelBtn.classList.remove('hidden');
                modalOkBtn.textContent = 'Highlight'; // Change text for highlight action

                // Store callbacks
                currentOkCallback = onOk;
                currentCancelCallback = onCancel;

                // Set up button handlers
                modalOkBtn.onclick = () => {
                    // Get the input value BEFORE closing the modal
                    const inputValue = highlightTextInput.value;
                    window.closeModal();
                    if (currentOkCallback) {
                        currentOkCallback(inputValue);
                    }
                };

                modalCancelBtn.onclick = () => {
                    window.closeModal();
                    if (currentCancelCallback) {
                        currentCancelCallback();
                    }
                };

                // Focus the input field
                setTimeout(() => {
                    highlightTextInput.focus();
                    highlightTextInput.select();
                }, 100);
            } else {
                highlightTextInput.classList.add('hidden');
                modalCancelBtn.classList.add('hidden');
                modalOkBtn.textContent = 'OK'; // Default OK text

                // For non-input modals, use simple close
                modalOkBtn.onclick = window.closeModal;
                modalCancelBtn.onclick = window.closeModal;
            }

            modal.classList.remove('hidden');
        };

        window.closeModal = () => {
            modal.classList.add('hidden');
            // Don't clear input value here - it's cleared after callback runs
            // Reset stored callbacks
            currentOkCallback = null;
            currentCancelCallback = null;
        };

        // --- Menu Functions ---
        const menuButton = document.getElementById('menu-button');
        const sideMenu = document.getElementById('side-menu');

        window.toggleMenu = () => {
            sideMenu.classList.toggle('open');
            // Hide menu button when side menu is open, show when closed
            menuButton.style.display = sideMenu.classList.contains('open') ? 'none' : 'block';
        };

        // Helper function to clean search text
        function cleanSearchText(text) {
            // Remove spaces from the beginning and end
            let cleaned = text.trim();
            // Remove ALL spaces from the text (including internal spaces)
            cleaned = cleaned.replace(/\s+/g, '');
            window.showDebugMessage(`Cleaned search text: "${text}" -> "${cleaned}"`, 'info');
            return cleaned;
        }

        // UPDATED: handleHighlightClick function - FIXED THE INPUT VALUE ISSUE
        window.handleHighlightClick = () => {
            window.toggleMenu(); // Close the side menu
            window.showModal('Highlight Text 0.5.4',
                'Enter text to highlight across the script:\n\nNote: Spaces will be ignored in the search.',
                false, true,
                (text) => {
                    window.showDebugMessage(`User entered text: "${text}"`, 'info');

                    // Clear existing highlights first (ALWAYS do this)
                    document.querySelectorAll('.highlight').forEach(el => el.remove());

                    if (!text || text.trim() === "") {
                        activeHighlightText = "";
                        window.showDebugMessage("Cleared all highlights (blank input)", 'info');
                        // NO MODAL - just clear highlights silently
                    } else {
                        // Clean the search text (remove all spaces)
                        activeHighlightText = cleanSearchText(text);
                        window.showDebugMessage(`Searching for: "${activeHighlightText}" (case-insensitive)`, 'info');

                        // DEBUG: Add a test highlight to see if function is called
                        window.showDebugMessage(`Calling renderHighlightsForText("${activeHighlightText}")`, 'info');

                        // Call the highlight function
                        renderHighlightsForText(activeHighlightText);
                    }

                    // Clear the input field after processing
                    highlightTextInput.value = '';
                },
                () => {
                    window.showDebugMessage("Highlight cancelled", 'info');
                    // Clear the input field on cancel too
                    highlightTextInput.value = '';
                }
            );
        };

        window.exitApp = () => {
            if (window.opener) {
                window.close(); // Try to close the current tab/window
            } else {
                // If it's the main window, simply show a message or redirect.
                // Cannot force close window not opened by script.
                window.showModal('Exit App', 'You can close this tab/window manually.', false);
            }
        };

        // --- Core App Initialization ---
        async function initializeFirebase() {
            try {
                if (!firebaseConfig.apiKey || Object.keys(firebaseConfig).length === 0) {
                     window.showModal('Configuration Error', 'Firebase API Key is missing or Firebase configuration is empty. Cannot initialize.', true);
                     return;
                }

                rtdb = getDatabase(app);
                auth = getAuth(app);

                await signInAnonymously(auth);
                userId = auth.currentUser?.uid || crypto.randomUUID();
                window.showDebugMessage("Actor User ID: " + userId, 'info');

                // Extract session_id and pdf_url from QR code URL
                const urlParams = new URLSearchParams(window.location.search);
                const sessionIdFromUrl = urlParams.get('session_id');
                const pdfUrlFromUrl = urlParams.get('pdf_url');

                if (!sessionIdFromUrl || !pdfUrlFromUrl) {
                    window.showModal('Connection Error', 'Missing Session ID or PDF URL in QR code link. Please scan the Stage Manager\'s QR code.', true);
                    document.getElementById('loading-message').textContent = 'Error: Missing session details.';
                    return;
                }

                currentSessionId = sessionIdFromUrl;
                currentPdfUrl = pdfUrlFromUrl;
                window.showDebugMessage(`Connected to Session: ${currentSessionId}, PDF URL: ${currentPdfUrl}`, 'info');

                document.getElementById('loading-message').textContent = `Connected to session ${currentSessionId}. Loading PDF...`;

                // Load and render PDF first
                await loadAndRenderPDF(currentPdfUrl);

                // Start listening for scroll state changes
                listenForScrollState();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                window.showModal('Initialization Failed', `Could not initialize Firebase: ${error.message}`, true);
                document.getElementById('loading-message').textContent = 'Error: Firebase initialization failed.';
            }
        }

        // --- PDF Rendering Functions ---
        async function renderPage(pageNumber, pdfPage) {
            // Scale to fit width of the viewer wrapper (which is 100vw)
            const scale = pdfViewerWrapper.clientWidth / pdfPage.getViewport({ scale: 1 }).width;
            const viewport = pdfPage.getViewport({ scale: scale });

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.id = `pdf-page-${pageNumber}`;
            canvas.setAttribute('data-page', pageNumber);
            // No absolute positioning here, will be handled by parent for full width

            const pageDiv = document.createElement('div');
            pageDiv.id = `page-div-${pageNumber}`;
            pageDiv.classList.add('pdf-page-wrapper'); // Add this class for consistent styling
            pageDiv.style.width = `${viewport.width}px`; // Explicit width to ensure centering and context
            pageDiv.style.height = `${viewport.height}px`; // Explicit height

            // Create the highlight overlay
            const highlightOverlay = document.createElement('div');
            highlightOverlay.className = 'highlight-overlay';
            highlightOverlay.id = `highlight-overlay-${pageNumber}`; // Give it an ID for targeting

            window.showDebugMessage(`Created overlay for page ${pageNumber}: ${highlightOverlay.id}`, 'info');

            pageDiv.appendChild(canvas);
            pageDiv.appendChild(highlightOverlay); // Append overlay AFTER canvas for z-index
            pdfViewerWrapper.appendChild(pageDiv);

            await pdfPage.render({ canvasContext: context, viewport: viewport }).promise;

            // Store text content and viewport for later highlighting
            const textContent = await pdfPage.getTextContent();
            pdfPage.textContentItems = textContent.items; // Attach for later use
            pdfPage.viewport = viewport; // Also store viewport for highlight positioning
        }

        async function loadAndRenderPDF(pdfUrl) {
            pdfViewerWrapper.innerHTML = '<p id="loading-message" class="text-center py-12 text-gray-500 text-lg">Loading PDF, please wait...</p>';
            try {
                const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
                pdfDoc = pdf;
                pdfViewerWrapper.innerHTML = ''; // Clear loading message

                window.showDebugMessage(`PDF loaded: ${pdf.numPages} pages`, 'info');

                // Render all pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    await renderPage(i, page);
                }

                // Initial scroll to top
                pdfViewerWrapper.scrollTop = 0;

            } catch (error) {
                console.error("PDF Loading Error:", error);
                window.showModal('PDF Loading Error', `Could not load PDF from URL. Check the URL and CORS settings. ${error.message}`, true);
                pdfViewerWrapper.innerHTML = '<p id="loading-message" class="text-center py-12 text-gray-500 text-lg">PDF loading failed.</p>';
                pdfDoc = null; // Reset document
            }
        }

        // --- Highlighting Logic ---
        async function renderHighlightsForText(searchText) {
            window.showDebugMessage(`STARTING renderHighlightsForText("${searchText}")`, 'info');

            // Clear all existing highlights before re-rendering
            const existingHighlights = document.querySelectorAll('.highlight').length;
            window.showDebugMessage(`Clearing ${existingHighlights} existing highlights`, 'info');
            document.querySelectorAll('.highlight').forEach(el => el.remove());

            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'highlight-loading';
            loadingIndicator.textContent = `Searching for "${searchText}"...`;
            loadingIndicator.style.display = 'block';
            document.body.appendChild(loadingIndicator);

            window.showDebugMessage(`Searching for "${searchText}" in PDF (case-insensitive, spaces ignored)...`, 'info');

            if (!pdfDoc) {
                window.showDebugMessage("ERROR: No PDF document loaded", 'error');
                if (loadingIndicator.parentNode) {
                    loadingIndicator.parentNode.removeChild(loadingIndicator);
                }
                return;
            }

            // Prepare search text: case-insensitive and clean
            const searchTextLower = searchText.toLowerCase();
            let totalHighlights = 0;
            let totalMatches = 0;

            // Search through all pages
            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                try {
                    window.showDebugMessage(`Processing page ${pageNum}...`, 'info');
                    const page = await pdfDoc.getPage(pageNum);
                    const textContent = await page.getTextContent();

                    // Get the highlight overlay for this page
                    const highlightOverlay = document.getElementById(`highlight-overlay-${pageNum}`);
                    if (!highlightOverlay) {
                        window.showDebugMessage(`No overlay for page ${pageNum}`, 'error');
                        continue;
                    }

                    // Get the canvas to match dimensions
                    const canvas = document.getElementById(`pdf-page-${pageNum}`);
                    if (!canvas) {
                        window.showDebugMessage(`No canvas for page ${pageNum}`, 'error');
                        continue;
                    }

                    // Get the viewport and scale
                    const viewport = page.getViewport({ scale: 1 });
                    const scale = canvas.width / viewport.width;

                    let pageHighlights = 0;
                    let pageMatches = 0;

                    // Search for text in this page (case-insensitive)
                    for (const textItem of textContent.items) {
                        // Clean the PDF text (remove spaces for comparison)
                        const pdfTextCleaned = textItem.str.replace(/\s+/g, '');

                        if (pdfTextCleaned.toLowerCase().includes(searchTextLower)) {
                            window.showDebugMessage(`Found match: "${textItem.str}" on page ${pageNum}`, 'info');

                            // Create highlight element
                            const highlightSpan = document.createElement('div');
                            highlightSpan.className = 'highlight';

                            // Use the text item's transform matrix to position the highlight
                            const transform = textItem.transform;

                            // Convert PDF coordinates to canvas coordinates
                            // PDF coordinates: bottom-left origin, Y goes up
                            // Canvas coordinates: top-left origin, Y goes down
                            const x = transform[4] * scale;

                            // FIX: Adjust Y position upward by the FULL height of the text
                            // The textItem.transform[5] gives the baseline position in PDF coordinates
                            // We need to move it upward by the full text height to align with the top of the text
                            const textHeight = (textItem.height || 15) * scale;
                            const y = (viewport.height - transform[5]) * scale - textHeight;

                            // Calculate width and height
                            const width = textItem.width * scale;
                            const height = textHeight; // Use the calculated height

                            // Set position and size
                            highlightSpan.style.left = `${x}px`;
                            highlightSpan.style.top = `${y}px`;
                            highlightSpan.style.width = `${width}px`;
                            highlightSpan.style.height = `${height}px`;

                            // Ensure no border or outline
                            highlightSpan.style.border = 'none';
                            highlightSpan.style.outline = 'none';
                            highlightSpan.style.boxShadow = 'none';

                            // Add a title for debugging
                            highlightSpan.setAttribute('title', `"${textItem.str}" → "${searchText}" (Page ${pageNum})`);

                            highlightOverlay.appendChild(highlightSpan);
                            pageHighlights++;
                            totalHighlights++;
                            pageMatches++;
                            totalMatches++;

                            window.showDebugMessage(`Added highlight at (${x.toFixed(1)}, ${y.toFixed(1)})`, 'info');
                        }
                    }

                    if (pageMatches > 0) {
                        window.showDebugMessage(`Found ${pageMatches} match(es) on page ${pageNum}`, 'info');
                    }

                } catch (error) {
                    window.showDebugMessage(`Error processing page ${pageNum}: ${error.message}`, 'error');
                }
            }

            // Remove loading indicator
            if (loadingIndicator.parentNode) {
                loadingIndicator.parentNode.removeChild(loadingIndicator);
            }

            // NO MODAL WINDOWS - just debug messages
            if (totalMatches > 0) {
                window.showDebugMessage(`SUCCESS: Highlighted "${searchText}" ${totalMatches} time(s) in the PDF`, 'info');
            } else {
                window.showDebugMessage(`No instances of "${searchText}" found (case-insensitive, spaces ignored)`, 'info');
            }

            window.showDebugMessage(`FINISHED renderHighlightsForText("${searchText}")`, 'info');
        }

        // --- Real-Time Synchronization (Actor Listener) ---
        function listenForScrollState() {
            if (!currentSessionId || !rtdb) {
                console.error("Cannot listen for scroll state: Session ID or RTDB not initialized.");
                window.showModal('Real-time Error', 'Cannot connect to session. Realtime Database not ready.', true);
                return;
            }

            const viewStateRef = ref(rtdb, `sessions/${currentSessionId}/viewState`);

            onValue(viewStateRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const targetPage = data.page;
                    const targetYPercent = data.y_percent;
                    scrollToPageAndPosition(targetPage, targetYPercent);
                }
            }, (error) => {
                console.error("Error listening to Realtime Database:", error);
                window.showModal('Real-time Error', `Failed to receive real-time updates: ${error.message}`, true);
            });
        }

        // --- Scrolling Logic for Actor App ---
        function scrollToPageAndPosition(pageNumber, yPercent) {
            if (!pdfDoc || !pdfViewerWrapper) return;

            const targetPageDiv = document.getElementById(`page-div-${pageNumber}`); // Target the page wrapper div

            if (targetPageDiv) {
                // Calculate target Y position relative to the start of the page
                const targetScrollY = targetPageDiv.offsetTop + (targetPageDiv.clientHeight * (yPercent / 100));

                pdfViewerWrapper.scrollTo({
                    top: targetScrollY,
                    behavior: 'smooth'
                });
            } else {
                console.warn(`Target page div for page ${pageNumber} not found.`);
            }
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            pdfViewerWrapper = document.getElementById('pdf-viewer-wrapper'); // Our main scrollable div
            initializeFirebase();

            // Attach event listener for menu button
            menuButton.addEventListener('click', window.toggleMenu);
            // Close menu if click outside (basic implementation)
            document.addEventListener('click', (event) => {
                if (sideMenu.classList.contains('open') &&
                    !sideMenu.contains(event.target) &&
                    !menuButton.contains(event.target)) {
                    window.toggleMenu();
                }
            });
        });

    </script>
</body>
</html>