<!DOCTYPE html>
<!-- DANGER! WARNING! THEATER! app for displaying PDF files to follow Stage Manager scrolling -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actor App</title>
    <!-- Tailwind CSS for mobile-first, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        #pdf-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border: 2px solid #334155;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: white;
            overflow-y: scroll;
            height: 90vh; /* Make it taller for actors */
        }
        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
</head>
<body class="p-4">

    <div id="main-ui" class="max-w-4xl mx-auto space-y-6">

        <h1 class="text-3xl font-bold text-gray-800 border-b pb-2 mb-4">Actor View</h1>
        <p class="text-sm text-gray-600">User ID: <span id="user-id-display" class="font-mono text-xs bg-gray-200 px-2 py-1 rounded">Loading...</span></p>
        <p class="text-lg font-medium text-indigo-600 mb-2">Connected to Session: <span id="session-id-display" class="font-mono text-xl bg-indigo-200 px-3 py-1 rounded-md">Not Connected</span></p>
        <p class="text-sm text-indigo-700 mb-4">PDF: <span id="pdf-url-display" class="font-mono text-xs bg-gray-200 px-2 py-1 rounded">Loading...</span></p>

        <!-- 3. PDF Viewer -->
        <div id="viewer-panel" class="bg-white p-4 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">Script Viewer</h2>
            <div id="pdf-container">
                <!-- PDF Canvases will be rendered here -->
                <p id="loading-message" class="text-center py-12 text-gray-500">Connecting to session and loading PDF...</p>
            </div>
        </div>

        <!-- Utility for error/message modal (Non-alert) -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-red-600">Error</h3>
                <p id="modal-message" class="text-gray-700 mb-6"></p>
                <button onclick="window.closeModal()" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Close</button>
            </div>
        </div>

    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Global Firebase Variables ---
        const firebaseConfig = {
          apiKey: "AIzaSyBG9pzEdllxWnZu0zYQMXqEFzJWNAVv6Lw",
          authDomain: "playscroller.firebaseapp.com",
          projectId: "playscroller",
          storageBucket: "playscroller.appspot.com",
          messagingSenderId: "86147104940",
          appId: "1:86147104940:web:f1bd908e1206795f9d1f09"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        let rtdb, auth, userId;
        let pdfDoc = null;
        let pdfContainer;
        let currentSessionId = null;
        let currentPdfUrl = null;

        // Ensure PDF.js worker is set up
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        // Helper function for modal display (instead of alert)
        window.showModal = (title, message, isError = true) => {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-title').className = isError ? 'text-xl font-bold mb-4 text-red-600' : 'text-xl font-bold mb-4 text-green-600';
            modal.style.display = 'flex';
        };

        window.closeModal = () => {
            document.getElementById('modal').style.display = 'none';
        };

        // --- Core App Initialization ---
        async function initializeFirebase() {
            try {
                if (!firebaseConfig.apiKey || Object.keys(firebaseConfig).length === 0) {
                     showModal('Configuration Error', 'Firebase API Key is missing or Firebase configuration is empty. Cannot initialize.', true);
                     return;
                }

                rtdb = getDatabase(app);
                auth = getAuth(app);

                await signInAnonymously(auth);
                userId = auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('user-id-display').textContent = userId;

                // Extract session_id and pdf_url from QR code URL
                const urlParams = new URLSearchParams(window.location.search);
                const sessionIdFromUrl = urlParams.get('session_id');
                const pdfUrlFromUrl = urlParams.get('pdf_url');

                if (!sessionIdFromUrl || !pdfUrlFromUrl) {
                    showModal('Connection Error', 'Missing Session ID or PDF URL in QR code link. Please scan the Stage Manager\'s QR code.', true);
                    document.getElementById('loading-message').textContent = 'Error: Missing session details.';
                    return;
                }

                currentSessionId = sessionIdFromUrl;
                currentPdfUrl = pdfUrlFromUrl;

                document.getElementById('session-id-display').textContent = currentSessionId;
                document.getElementById('pdf-url-display').textContent = currentPdfUrl;


                // Load and render PDF first
                await loadAndRenderPDF(currentPdfUrl);

                // Start listening for scroll state changes
                listenForScrollState();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showModal('Initialization Failed', `Could not initialize Firebase: ${error.message}`, true);
                document.getElementById('loading-message').textContent = 'Error: Firebase initialization failed.';
            }
        }

        // --- PDF Rendering Functions (Same as SM app) ---
        async function renderPage(pageNumber, pdfPage) {
            const viewport = pdfPage.getViewport({ scale: 1.5 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.id = `pdf-page-${pageNumber}`;
            canvas.setAttribute('data-page', pageNumber);

            await pdfPage.render({ canvasContext: context, viewport: viewport }).promise;
            pdfContainer.appendChild(canvas);
        }

        async function loadAndRenderPDF(pdfUrl) {
            document.getElementById('pdf-container').innerHTML = '<p id="loading-message" class="text-center py-12 text-gray-500">Loading PDF, please wait...</p>';
            try {
                const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
                pdfDoc = pdf;
                document.getElementById('pdf-container').innerHTML = ''; // Clear loading message

                // Render all pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    await renderPage(i, page);
                }

                // Initial scroll to top
                pdfContainer.scrollTop = 0;

            } catch (error) {
                console.error("PDF Loading Error:", error);
                showModal('PDF Loading Error', `Could not load PDF from URL. Check the URL and CORS settings. ${error.message}`, true);
                document.getElementById('pdf-container').innerHTML = '<p id="loading-message" class="text-center py-12 text-gray-500">PDF loading failed.</p>';
                pdfDoc = null; // Reset document
            }
        }

        // --- Real-Time Synchronization (Actor Listener) ---
        function listenForScrollState() {
            if (!currentSessionId || !rtdb) {
                console.error("Cannot listen for scroll state: Session ID or RTDB not initialized.");
                showModal('Real-time Error', 'Cannot connect to session. Realtime Database not ready.', true);
                return;
            }

            const viewStateRef = ref(rtdb, `sessions/${currentSessionId}/viewState`);

            onValue(viewStateRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const targetPage = data.page;
                    const targetYPercent = data.y_percent;

                    // Implement smooth scrolling
                    scrollToPageAndPosition(targetPage, targetYPercent);
                }
            }, (error) => {
                console.error("Error listening to Realtime Database:", error);
                showModal('Real-time Error', `Failed to receive real-time updates: ${error.message}`, true);
            });
        }

        // --- Scrolling Logic for Actor App ---
        function scrollToPageAndPosition(pageNumber, yPercent) {
            if (!pdfDoc || !pdfContainer) return;

            const targetCanvas = document.getElementById(`pdf-page-${pageNumber}`);

            if (targetCanvas) {
                const targetScrollY = targetCanvas.offsetTop + (targetCanvas.offsetHeight * (yPercent / 100));

                // Implement smooth scroll if desired
                pdfContainer.scrollTo({
                    top: targetScrollY,
                    behavior: 'smooth'
                    // You might need to adjust duration or curve if 'smooth' isn't smooth enough
                });
            } else {
                console.warn(`Target canvas for page ${pageNumber} not found.`);
            }
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            pdfContainer = document.getElementById('pdf-container');
            initializeFirebase();
        });

    </script>
</body>
</html>
