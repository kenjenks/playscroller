<!DOCTYPE html>
<!-- DANGER! WARNING! THEATER! app for displaying PDF files on actors' devices -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stage Manager App (SM)</title>
    <!-- Tailwind CSS for mobile-first, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        /* Full-screen PDF container */
        #pdf-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: scroll;
            background-color: white;
            z-index: 1;
        }
        canvas {
            display: block;
            margin: 0 auto;
        }
        /* Custom scrollbar */
        #pdf-container::-webkit-scrollbar {
            width: 8px;
        }
        #pdf-container::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 10px;
        }

        /* --- Hamburger Menu Styles --- */
        #menu-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 9999px;
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: block;
        }
        #menu-button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        #side-menu {
            position: fixed;
            top: 0;
            right: 0;
            width: 250px;
            height: 100%;
            background-color: #fff;
            box-shadow: -4px 0 10px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            z-index: 999;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        #side-menu.open {
            transform: translateX(0);
        }
        #side-menu ul {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
            flex-grow: 1;
        }
        #side-menu li {
            margin-bottom: 0.75rem;
        }
        #side-menu button {
            width: 100%;
            padding: 0.75rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            text-align: left;
            font-size: 1rem;
            color: #1f2937;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #side-menu button:hover {
            background-color: #e5e7eb;
        }

        /* Welcome screen */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 2rem;
        }

        /* QR Code display in modal */
        #qr-code-display {
            text-align: center;
            margin-top: 1rem;
        }
        #qr-code-display canvas {
            margin: 0 auto;
            border: 1px solid #e5e7eb;
            padding: 10px;
            background: white;
        }

        /* Debug info */
        #debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            z-index: 1001;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Status indicator */
        #status-indicator {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <!-- QRious QR Code generation library -->
    <script src="https://unpkg.com/qrious@4.0.2/dist/qrious.min.js"></script>
</head>
<body>

    <!-- Status Indicator -->
    <div id="status-indicator" class="hidden">
        <span id="status-text">Loading...</span>
    </div>

    <!-- Welcome Screen (shown initially) -->
    <div id="welcome-screen">
        <div class="max-w-md mx-auto text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Stage Manager Control</h1>
            <p class="text-gray-600 mb-8">Welcome to PlayScroller. Use the menu in the top right to set up your script and start a session.</p>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <p class="text-gray-700 mb-4">Current User ID:</p>
                <p id="user-id-display" class="font-mono text-sm bg-gray-100 px-4 py-2 rounded mb-6">Loading...</p>
                <button id="start-with-url-btn" class="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">
                    Start with URL from QR Code
                </button>
                <p class="text-sm text-gray-500 mt-4">Or use the menu to manually enter a PDF URL</p>
            </div>
            <div id="url-info" class="mt-4 text-sm text-gray-600 hidden">
                <p>URL Parameter detected:</p>
                <p id="detected-url" class="font-mono text-xs bg-yellow-100 p-2 rounded"></p>
            </div>
        </div>
    </div>

    <!-- Full-screen PDF Viewer -->
    <div id="pdf-container" class="hidden">
        <!-- PDF Canvases will be rendered here -->
        <p id="loading-message" class="text-center py-12 text-gray-500">Loading PDF, please wait...</p>
    </div>

    <!-- Hamburger Menu Button -->
    <button id="menu-button" class="hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>

    <!-- Side Menu Panel -->
    <div id="side-menu">
        <button class="self-end p-2 bg-transparent text-gray-500 hover:text-gray-800" onclick="window.toggleMenu()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <ul>
            <li><button id="set-pdf-url-btn">Set PDF URL...</button></li>
            <li><button id="show-qr-btn" class="hidden">Show Actor QR Code</button></li>
            <li><button id="reset-btn">Reset Session</button></li>
            <li><button id="debug-btn">Debug Info</button></li>
        </ul>
    </div>

    <!-- Modal for PDF URL Input -->
    <div id="pdf-url-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Set PDF Script URL</h3>
            <p class="text-gray-700 mb-4">Enter the public URL of your script PDF:</p>
            <input type="url" id="pdf-url-input" placeholder="e.g., https://example.com/script.pdf"
                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500 mb-4">
            <p class="text-sm text-gray-500 mb-4">Note: The PDF must be publicly accessible with CORS headers enabled.</p>
            <div class="flex justify-end space-x-4">
                <button id="pdf-url-cancel" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="pdf-url-ok" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Load PDF</button>
            </div>
        </div>
    </div>

    <!-- Modal for QR Code Display -->
    <div id="qr-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Actor Sync QR Code</h3>
            <p class="text-gray-700 mb-4">Actors should scan this QR code to join the session:</p>
            <div id="qr-code-display">
                <!-- QR code will be rendered here -->
            </div>
            <p id="session-id-display" class="text-center font-mono text-sm bg-indigo-50 px-3 py-2 rounded mt-4"></p>
            <div class="flex justify-end mt-6">
                <button id="qr-modal-close" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Close</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="error-title" class="text-xl font-bold mb-4 text-red-600">Error</h3>
            <p id="error-message" class="text-gray-700 mb-6"></p>
            <button id="error-close" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Close</button>
        </div>
    </div>

    <!-- Debug Info Panel -->
    <div id="debug-info" class="hidden">
        <div id="debug-content"></div>
        <button onclick="toggleDebug()" class="mt-2 text-xs bg-blue-500 text-white px-2 py-1 rounded">Toggle Debug</button>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Global Firebase Variables ---
        const firebaseConfig = {

          apiKey: "AIzaSyBG9pzEdllxWnZu0zYQMXqEFzJWNAVv6Lw",
          authDomain: "playscroller.firebaseapp.com",
          projectId: "playscroller",
          storageBucket: "playscroller.appspot.com",
          messagingSenderId: "86147104940",
          appId: "1:86147104940:web:f1bd908e1206795f9d1f09"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        let rtdb, auth, userId;
        let pdfDoc = null;
        let pdfContainer;
        let currentSessionId = null;
        let currentPdfUrl = null;
        let debugMessages = [];
        let pdfUrlFromParam = null;

        // Ensure PDF.js worker is set up
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        // Debug logging
        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugMessages.push(`[${timestamp}] ${message}`);
            if (debugMessages.length > 20) debugMessages.shift();

            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                debugContent.innerHTML = debugMessages.join('<br>');
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            console.log(message);
        }

        function toggleDebug() {
            const debugPanel = document.getElementById('debug-info');
            debugPanel.classList.toggle('hidden');
        }

        // Update status indicator
        function updateStatus(message, isError = false) {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');

            statusText.textContent = message;
            statusIndicator.classList.remove('hidden');

            if (isError) {
                statusIndicator.style.backgroundColor = 'rgba(220, 38, 38, 0.8)'; // red
            } else {
                statusIndicator.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            }
        }

        // Function to get actor app URL from current SM app URL
        function getActorAppUrl() {
            const currentUrl = window.location.href;
            // Replace "sm-app.html" with "actor-app.html" in the current URL
            const actorAppUrl = currentUrl.replace(/sm-app\.html.*$/, 'actor-app.html');
            return actorAppUrl;
        }

        // Generate a session ID
        function generateSessionId() {
            return 'SESS-' + Date.now().toString(36) + Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        // Convert Google Drive view link to direct download link
        function convertGoogleDriveLink(url) {
            if (!url) return url;

            logDebug(`Converting Google Drive link: ${url}`);

            // Pattern for Google Drive view links
            const viewPattern = /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/;
            const match = url.match(viewPattern);

            if (match) {
                const fileId = match[1];
                const directUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                logDebug(`Converted to direct download: ${directUrl}`);
                return directUrl;
            }

            // If it's already a direct link or not Google Drive, return as-is
            return url;
        }

        // Show/hide menu
        window.toggleMenu = () => {
            const sideMenu = document.getElementById('side-menu');
            sideMenu.classList.toggle('open');
        };

        // Show modal functions
        function showPdfUrlModal() {
            document.getElementById('pdf-url-modal').classList.remove('hidden');
            document.getElementById('pdf-url-input').focus();
        }

        function closePdfUrlModal() {
            document.getElementById('pdf-url-modal').classList.add('hidden');
            document.getElementById('pdf-url-input').value = '';
        }

        function showQrModal() {
            if (!currentSessionId || !currentPdfUrl) {
                showError('No Active Session', 'Please load a PDF first to start a session.');
                return;
            }

            const actorAppUrl = getActorAppUrl();
            const actorSyncUrl = `${actorAppUrl}?session_id=${currentSessionId}&pdf_url=${encodeURIComponent(currentPdfUrl)}`;

            logDebug(`QR Code URL: ${actorSyncUrl}`);

            // Update session ID display
            document.getElementById('session-id-display').textContent = `Session: ${currentSessionId}`;

            // Generate QR code
            const qrDisplay = document.getElementById('qr-code-display');
            qrDisplay.innerHTML = '';
            const qrCanvas = document.createElement('canvas');
            qrDisplay.appendChild(qrCanvas);

            new QRious({
                element: qrCanvas,
                value: actorSyncUrl,
                size: 200,
                background: '#ffffff',
                foreground: '#3730a3',
                level: 'H'
            });

            document.getElementById('qr-modal').classList.remove('hidden');
        }

        function closeQrModal() {
            document.getElementById('qr-modal').classList.add('hidden');
        }

        function showError(title, message) {
            logDebug(`Error: ${title} - ${message}`);
            updateStatus(`Error: ${title}`, true);
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
        }

        function closeErrorModal() {
            document.getElementById('error-modal').classList.add('hidden');
        }

        // Extract URL parameters
        function extractUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const pdfUrl = urlParams.get('pdfurl') || urlParams.get('pdf_url');

            if (pdfUrl) {
                // Decode the URL (it might be encoded)
                const decodedUrl = decodeURIComponent(pdfUrl);
                pdfUrlFromParam = decodedUrl;

                // Show the detected URL on welcome screen
                document.getElementById('url-info').classList.remove('hidden');
                document.getElementById('detected-url').textContent = decodedUrl;

                // Pre-fill the modal input
                document.getElementById('pdf-url-input').value = decodedUrl;

                logDebug(`Extracted PDF URL from parameters: ${decodedUrl}`);
            }

            return pdfUrlFromParam;
        }

        // --- Core App Initialization ---
        async function initializeFirebase() {
            try {
                logDebug('Initializing Firebase...');

                if (!firebaseConfig.apiKey || Object.keys(firebaseConfig).length === 0) {
                    showError('Configuration Error', 'Firebase API Key is missing or Firebase configuration is empty.');
                    return;
                }

                rtdb = getDatabase(app);
                auth = getAuth(app);

                // Authenticate user
                logDebug('Authenticating user...');
                updateStatus('Authenticating...');
                await signInAnonymously(auth);
                userId = auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('user-id-display').textContent = userId;
                logDebug(`User ID: ${userId}`);

                // Show menu button
                document.getElementById('menu-button').classList.remove('hidden');

                // Extract URL parameters
                extractUrlParameters();

                if (pdfUrlFromParam) {
                    // Auto-start with URL from QR code
                    logDebug(`Auto-starting with PDF URL: ${pdfUrlFromParam}`);
                    updateStatus(`Loading PDF from URL...`);
                    document.getElementById('welcome-screen').classList.add('hidden');
                    await startSession(pdfUrlFromParam);
                } else {
                    logDebug('No PDF URL parameter found, showing welcome screen');
                    updateStatus('Ready - No PDF loaded');
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showError('Initialization Failed', `Could not initialize Firebase: ${error.message}`);
            }
        }

        // --- PDF Rendering Functions ---
        async function renderPage(pageNumber, pdfPage) {
            const viewport = pdfPage.getViewport({ scale: 1.5 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.id = `pdf-page-${pageNumber}`;
            canvas.setAttribute('data-page', pageNumber);

            await pdfPage.render({ canvasContext: context, viewport: viewport }).promise;
            pdfContainer.appendChild(canvas);
        }

        async function loadAndRenderPDF(pdfUrl) {
            logDebug(`Loading PDF from: ${pdfUrl}`);
            updateStatus(`Loading PDF...`);

            // Show PDF container immediately with loading message
            document.getElementById('pdf-container').classList.remove('hidden');
            document.getElementById('pdf-container').innerHTML = '<p id="loading-message" class="text-center py-12 text-gray-500">Loading PDF, please wait...</p>';

            try {
                // Convert Google Drive link if needed
                const finalPdfUrl = convertGoogleDriveLink(pdfUrl);
                logDebug(`Final PDF URL: ${finalPdfUrl}`);

                const pdf = await pdfjsLib.getDocument({
                    url: finalPdfUrl,
                    withCredentials: false
                }).promise;

                pdfDoc = pdf;
                pdfContainer.innerHTML = ''; // Clear loading message

                // Render all pages
                updateStatus(`Rendering ${pdf.numPages} pages...`);
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    await renderPage(i, page);
                }

                logDebug(`Successfully loaded PDF with ${pdf.numPages} pages`);
                updateStatus(`Loaded ${pdf.numPages} pages - Session: ${currentSessionId}`);

                // Initial broadcast after loading
                broadcastScrollState();

            } catch (error) {
                console.error("PDF Loading Error:", error);
                logDebug(`PDF Loading Error: ${error.message}`);
                let errorMsg = `Could not load PDF from URL. ${error.message}`;

                // Provide more helpful error messages
                if (error.message.includes('CORS')) {
                    errorMsg += '\n\nCORS Error: The PDF server needs to allow cross-origin requests.';
                } else if (error.message.includes('404') || error.message.includes('Not Found')) {
                    errorMsg += '\n\nFile not found. Check the URL.';
                } else if (error.message.includes('Invalid PDF')) {
                    errorMsg += '\n\nThis might not be a valid PDF file.';
                }

                showError('PDF Loading Error', errorMsg);
                pdfContainer.innerHTML = '<p id="loading-message" class="text-center py-12 text-gray-500">PDF loading failed.</p>';
                pdfDoc = null;
                // Reset session
                currentSessionId = null;
                currentPdfUrl = null;
                document.getElementById('show-qr-btn').classList.add('hidden');
            }
        }

        // Start a new session
        async function startSession(pdfUrl) {
            if (!rtdb || !userId) {
                showError('System Error', 'Firebase Realtime Database not initialized or User not authenticated.');
                return;
            }

            currentPdfUrl = pdfUrl;
            currentSessionId = generateSessionId();

            logDebug(`Starting session: ${currentSessionId} with PDF: ${pdfUrl}`);
            updateStatus(`Starting session ${currentSessionId}...`);

            // Create session metadata in Realtime Database
            const metadataRef = ref(rtdb, `sessions/${currentSessionId}/metadata`);
            const sessionMetadata = {
                sm_id: userId,
                pdf_url: pdfUrl,
                timestamp: Date.now(),
                status: 'active'
            };

            // Initialize view state in Realtime Database
            const viewStateRef = ref(rtdb, `sessions/${currentSessionId}/viewState`);
            const initialViewState = {
                page: 1,
                y_percent: 0,
                timestamp: Date.now()
            };

            try {
                await set(metadataRef, sessionMetadata);
                await set(viewStateRef, initialViewState);

                logDebug(`Session created in Firebase: ${currentSessionId}`);
                updateStatus(`Session ${currentSessionId} created, loading PDF...`);

                // Load and render PDF
                await loadAndRenderPDF(pdfUrl);

                // Update UI
                document.getElementById('pdf-container').classList.remove('hidden');
                document.getElementById('show-qr-btn').classList.remove('hidden');

                // Hide welcome screen if still showing
                document.getElementById('welcome-screen').classList.add('hidden');

                logDebug(`Session started successfully: ${currentSessionId}`);
                updateStatus(`Session ${currentSessionId} active - ${pdfDoc ? pdfDoc.numPages : 0} pages`);

            } catch (error) {
                console.error("Session start failed:", error);
                logDebug(`Session start failed: ${error.message}`);
                showError('Session Failed', `Could not start session or write to Realtime Database. Error: ${error.message}`);
                currentSessionId = null;
                currentPdfUrl = null;
                document.getElementById('show-qr-btn').classList.add('hidden');
            }
        }

        // Reset session
        function resetSession() {
            logDebug('Resetting session');
            updateStatus('Resetting session...');
            currentSessionId = null;
            currentPdfUrl = null;
            pdfDoc = null;

            // Clear PDF container
            if (pdfContainer) {
                pdfContainer.innerHTML = '<p id="loading-message" class="text-center py-12 text-gray-500">No PDF loaded.</p>';
                pdfContainer.classList.add('hidden');
            }

            // Hide QR button
            document.getElementById('show-qr-btn').classList.add('hidden');

            // Show welcome screen
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('status-indicator').classList.add('hidden');

            window.toggleMenu(); // Close menu

            updateStatus('Ready - Session reset');
            setTimeout(() => {
                document.getElementById('status-indicator').classList.add('hidden');
            }, 2000);
        }

        // Throttle utility function
        const throttle = (func, limit) => {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // --- Core Scroll Logic ---
        function getCurrentScrollState() {
            const container = pdfContainer;
            const scrollY = container.scrollTop;
            const containerHeight = container.clientHeight;
            let currentCanvas = null;

            // Find the visible canvas page
            const canvases = container.querySelectorAll('canvas');
            for (const canvas of canvases) {
                const canvasTop = canvas.offsetTop;
                const canvasBottom = canvas.offsetTop + canvas.offsetHeight;

                if (scrollY >= canvasTop && scrollY < canvasBottom) {
                    currentCanvas = canvas;
                    break;
                }
            }

            if (!currentCanvas) {
                if (canvases.length > 0 && scrollY < canvases[0].offsetTop + canvases[0].offsetHeight) {
                    currentCanvas = canvases[0];
                } else if (canvases.length > 0) {
                    currentCanvas = canvases[canvases.length - 1];
                } else {
                    return null;
                }
            }

            const pageNumber = parseInt(currentCanvas.getAttribute('data-page'), 10);
            const pageHeight = currentCanvas.offsetHeight;
            const pageTop = currentCanvas.offsetTop;
            const scrollInPage = scrollY - pageTop;

            let yPercent = Math.min(100, Math.max(0, (scrollInPage / pageHeight) * 100));

            // Handle edge cases
            if (scrollY + containerHeight >= container.scrollHeight - 5) {
                yPercent = 100;
            }

            if (scrollInPage <= 10) {
                yPercent = 0;
            }

            return { page: pageNumber, y_percent: parseFloat(yPercent.toFixed(2)) };
        }

        const broadcastScrollState = throttle(async () => {
            if (!currentSessionId || !rtdb || !pdfDoc) return;

            const state = getCurrentScrollState();
            if (!state) return;

            const viewStateRef = ref(rtdb, `sessions/${currentSessionId}/viewState`);

            try {
                await update(viewStateRef, {
                    page: state.page,
                    y_percent: state.y_percent,
                    timestamp: Date.now()
                });

                logDebug(`Broadcasting: Page ${state.page} @ ${state.y_percent.toFixed(0)}%`);
                updateStatus(`Page ${state.page} @ ${state.y_percent.toFixed(0)}%`);

            } catch (e) {
                console.error("Broadcast failed:", e);
                logDebug(`Broadcast failed: ${e.message}`);
            }

        }, 150); // Throttle to 150ms

        // Event handler for scrolling
        window.handleScroll = () => {
            if (pdfDoc && currentSessionId) {
                broadcastScrollState();
            }
        };

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            pdfContainer = document.getElementById('pdf-container');

            // Set up debug toggle
            window.toggleDebug = toggleDebug;

            // Fix for "Set PDF URL..." button not working
            // Add click handler directly to the button
            document.getElementById('set-pdf-url-btn').onclick = function() {
                window.toggleMenu();
                showPdfUrlModal();
            };

            initializeFirebase();

            // Set up event listeners
            document.getElementById('menu-button').addEventListener('click', window.toggleMenu);

            // Menu button clicks (using onclick instead of addEventListener for reliability)
            document.getElementById('show-qr-btn').onclick = function() {
                window.toggleMenu();
                showQrModal();
            };

            document.getElementById('reset-btn').onclick = function() {
                resetSession();
            };

            document.getElementById('debug-btn').onclick = function() {
                window.toggleMenu();
                toggleDebug();
            };

            // PDF URL modal buttons
            document.getElementById('pdf-url-ok').onclick = async function() {
                const pdfUrl = document.getElementById('pdf-url-input').value.trim();
                if (!pdfUrl) {
                    showError('Input Required', 'Please enter a PDF URL.');
                    return;
                }

                closePdfUrlModal();
                await startSession(pdfUrl);
            };

            document.getElementById('pdf-url-cancel').onclick = closePdfUrlModal;

            // QR modal close button
            document.getElementById('qr-modal-close').onclick = closeQrModal;

            // Error modal close button
            document.getElementById('error-close').onclick = closeErrorModal;

            // Start with URL button on welcome screen
            document.getElementById('start-with-url-btn').onclick = function() {
                document.getElementById('welcome-screen').classList.add('hidden');
                showPdfUrlModal();
            };

            // PDF container scroll listener
            pdfContainer.addEventListener('scroll', window.handleScroll);

            // Close menu when clicking outside
            document.addEventListener('click', (event) => {
                const sideMenu = document.getElementById('side-menu');
                const menuButton = document.getElementById('menu-button');

                if (sideMenu.classList.contains('open') &&
                    !sideMenu.contains(event.target) &&
                    !menuButton.contains(event.target)) {
                    window.toggleMenu();
                }
            });

            // Allow Enter key in PDF URL input
            document.getElementById('pdf-url-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('pdf-url-ok').click();
                }
            });

            // Force debug panel to be visible for testing
            setTimeout(() => {
                document.getElementById('debug-info').classList.remove('hidden');
            }, 1000);
        });

    </script>
</body>
</html>